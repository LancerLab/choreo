// RUN: choreo -e %s | FileCheck %s --match-full-lines

__co__ auto with_statement_empty_body() {
  span1 : [7, 8];
  span2 : [13];
  span3 : [13];
  int coordx = 0;
  int coordy = 0;
  int coordz = 0;
  parallel p by 6 {
    with index1 in span1,
         index2 in span2,
         index3 in span3 {
      // TODO: use with-body = "{ statements }"
    }
  }
}

// CHECK: `- Name: with_statement_empty_body
// CHECK: `- With Block:
// CHECK: (within constraints)
// CHECK-NOT: (where clause)
// CHECK: (with empty statements)

__co__ auto with_statement_unnamed_mdspans(f32 mdspan<2> data) {
  parallel p by 6 {
    with index1 in [2, 3],
         index2 in data.span {
    }
  }
}

// CHECK: `- Name: with_statement_unnamed_mdspans
// CHECK: `- With Block:
// CHECK: (within constraints)
// CHECK-NOT: (where clause)
// CHECK: (with empty statements)

__co__ auto with_statement_multi_within() {
  span_v1_1 : [7, 8];
  span_v1_2 : [13];
  span_v1_3 : [13];
  int coord_v1_x = 0;
  int coord_v1_y = 0;
  int coord_v1_z = 0;
  parallel p_v1_ by 6 {
    with index_v1_1 in span_v1_1,
         index_v1_2 in span_v1_2,
         index_v1_3 in span_v1_3 {
      // TODO: do we need to segment assign and
      // assign-fused operation like assign-add
      coord_v1_x = coord_v1_x + index_v1_1(0);
      coord_v1_w = coord_v1_x + index_v1_1(1);
      coord_v1_y = coord_v1_x + index_v1_2(0);
      coord_v1_z = coord_v1_y + index_v1_3(0);
    }
  }
}

// CHECK: `- Name: with_statement_multi_within
// CHECK: `- With Block:
// CHECK: (within constraints)
// CHECK-NOT: (where clause)
// CHECK: (with statements)


__co__ auto with_statement_pattern_match_like_within() {
  span_v4 : [7, 8];
  int coord_v4_x = 0;
  parallel p by 6 {
    with index1 = {x, y} in span_v4 {
      // TODO: use with-body = "{ statements }"
      coord_v4_x = coord_v4_x + x;
      coord_v4_y = coord_v4_x + y;
    }
  }
}

// CHECK: `- Name: with_statement_pattern_match_like_within
// CHECK: `- With Block:
// CHECK: (within constraints)
// CHECK: `- index1 = {x, y} in span_v4
// CHECK-NOT: (where clause)
// CHECK: (with statements)

__co__ void with_statement_where_clause() {
  span_v2_1 : [7, 8];
  span_v2_2 : [13];
  span_v2_3 : [13];
  int coord_v2_x = 0;
  int coord_v2_y = 0;
  int coord_v2_z = 0;
  parallel p_v2_ by 6 {
    with index_v2_1 in span_v2_1,
         index_v2_2 in span_v2_2,
         index_v2_3 in span_v2_3
    where index_v2_2 <-> index_v2_3 {
      coord_v2_x = coord_v2_x + index_v2_1(0);
      coord_v2_w = coord_v2_x + index_v2_1(1);
      coord_v2_y = coord_v2_x + index_v2_2(0);
      coord_v2_z = coord_v2_y + index_v2_3(0);
    }
  }
}

// CHECK: `- Name: with_statement_where_clause
// CHECK: `- With Block:
// CHECK: (within constraints)
// CHECK: (where clause)
// CHECK: (with statements)


__co__ void with_statement_where_clauses() {
  span_v3_1 : [7, 8];
  span_v3_2 : [13];
  span_v3_3 : [13];
  int coord_v3_x = 0;
  int coord_v3_y = 0;
  int coord_v3_z = 0;
  parallel p_v3_ by 6 {
    with index_v3_1 in span_v3_1,
         index_v3_2 in span_v3_2,
         index_v3_3 in span_v3_3
    where index_v3_2 <-> index_v3_3 {
      coord_v3_a = coord_v3_x + index_v3_1(0);
      coord_v3_b = coord_v3_x + index_v3_1(1);
      coord_v3_y = coord_v3_x + index_v3_2(0);
      coord_v3_z = coord_v3_y + index_v3_3(0);
    }
  }
}

// CHECK: `- Name: with_statement_where_clauses
// CHECK: `- With Block:
// CHECK: (within constraints)
// CHECK: (where clause)
// CHECK: (with statements)

__co__ void with_statement_matcher_only() {
  span_v4 : [7, 8];
  int coord_v4_x = 0;
  parallel p by 6 {
    with {x, y} in span_v4 {
      coord_v4_x = coord_v4_x + x;
      coord_v4_y = coord_v4_x + y;
    }
  }
}

