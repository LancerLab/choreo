// RUN: choreo -e %s | FileCheck --match-full-lines %s

__co__ auto chunkat_tile_one(s32 [4, 8, 16] i) {
  s32 [i.span] o;
  parallel p by 4 {
    l0 = dma.copy i => local;
    // l1 = dma.copy i.chunkat(_, _, _) => local;
    with {t0} in [2] {
      foreach t0 {
        l2 = dma.copy i.chunkat(t0, _, _) => local;
        l3 = dma.copy i.chunkat(_, t0, _) => local;
        l4 = dma.copy i.chunkat(_, t0, t0) => local;
        l5 = dma.copy i.chunkat(_, t0, _) => local;
        dma.copy l5 => o.chunkat(_, t0, _);
      }
    }
  }
}

// CHECK: `- Parallelization:  index symbol: p, bound [0, 4)
// CHECK:  `- DMA.copy
// CHECK:    `- future: l0
// CHECK:    `- from: i
// CHECK:    `- to: local
// CHECK:  `- With Block:
// CHECK:    (within constraints)
// CHECK:    `-  {t0} in [ 2 ]
// CHECK:    (with statements)
// CHECK:    `- Foreach Block:
// CHECK:     `- Iteration variables: t0
// CHECK:     `- DMA.copy
// CHECK:       `- future: l2
// CHECK:       `- from: i.ChunkAt(t0, __choreo_no_tiling__, __choreo_no_tiling__)
// CHECK:       `- to: local
// CHECK:     `- DMA.copy
// CHECK:       `- future: l3
// CHECK:       `- from: i.ChunkAt(__choreo_no_tiling__, t0, __choreo_no_tiling__)
// CHECK:       `- to: local
// CHECK:     `- DMA.copy
// CHECK:       `- future: l4
// CHECK:       `- from: i.ChunkAt(__choreo_no_tiling__, t0, t0)
// CHECK:       `- to: local
// CHECK:     `- DMA.copy
// CHECK:       `- future: l5
// CHECK:       `- from: i.ChunkAt(__choreo_no_tiling__, t0, __choreo_no_tiling__)
// CHECK:       `- to: local
// CHECK:     `- DMA.copy
// CHECK:       `- from: l5
// CHECK:       `- to: o.ChunkAt(__choreo_no_tiling__, t0, __choreo_no_tiling__)

