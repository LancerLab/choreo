// RUN: choreo -e %s | FileCheck --match-full-lines %s

__co__ void data_access(f32 [7, 4] a, f32 [7, 4] b) {
  foreach i in a.span {
    a.at(i) = b.at(i);
    println(&a.at(i));
  }
}

// CHECK: ChoreoFunction
// CHECK:  `- Name: data_access
// CHECK:  `- Return type: void
// CHECK:  `- Parameters:
// CHECK:    `-  type: f32 [ 7 4 ], symbol: a
// CHECK:    `-  type: f32 [ 7 4 ], symbol: b
// CHECK:  `- With Block:
// CHECK:    (within constraints)
// CHECK:    `- i in a.span
// CHECK:    (with statements)
// CHECK:    `- Foreach Block:
// CHECK:     `- Iteration variables: i
// CHECK:     `- Assign: a[i] = b[i]
// CHECK:     `- Call: println (built-in)
// CHECK:       `- with arguments:  (addrof a[i])


__co__ auto foo(s32 [4, 8] a) {
  parallel by 1 {
    l = dma.copy a => local;
    foreach idx in [4, 8] {
      l.data.at(idx) += 0x100;
    }
    dma.copy l => a;
  }
  return a;
}

// CHECK: ChoreoFunction
// CHECK:  `- Name: foo
// CHECK:  `- Return type: unknown
// CHECK:  `- Parameters:
// CHECK:    `-  type: s32 [ 4 8 ], symbol: a
// CHECK:  `- Parallelization: index symbol: anon_0, bound [0, 1)
// CHECK:   `- DMA.copy
// CHECK:     `- future: l
// CHECK:     `- from: a
// CHECK:     `- to: local
// CHECK:   `- With Block:
// CHECK:     (within constraints)
// CHECK:     `- idx in [ 4 8 ]
// CHECK:     (with statements)
// CHECK:     `- Foreach Block:
// CHECK:      `- Iteration variables: idx
// CHECK:      `- Assign: l.data[idx] =  (l.data[idx] + 256) 
// CHECK:   `- DMA.copy
// CHECK:     `- from: l
// CHECK:     `- to: a
// CHECK:  `- Return: a

int main() {
  auto input = choreo::make_spandata<choreo::s32>(4, 8);
  input.fill(256);
  
  auto res = foo(input.view());

  for (int i = 0; i < res.shape()[0]; ++i) {
    for (int j = 0; j < res.shape()[1]; ++j) {
      std::cout << res[i][j] << " ";
    }
    std::cout << std::endl;
  }
}
