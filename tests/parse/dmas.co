// RUN: choreo -e %s | FileCheck %s --match-full-lines

__co__ void dma_test(int b, f32 [36, 27, 128] input) {
  ndims: [3, b];
  int sum = 0;
  parallel p by 6 {
    with index in ndims {
      foreach index {
        f = dma.pad.async<{1, 1}, {0, 0}, {1, 0}, 1> input.chunkat(p, index) => local;
        f1 = dma.pad<{0, 0, 0}, {0, 1, 2}, {1, 0, 3}, 0> input.chunkat(p, index) => local;
        sum = sum + index(0);
        wait f, f1;
        call cfunction(f.data, f1.data);
      }
    }
  }
}

// CHECK: ChoreoFunction
// CHECK:  `- Name: dma_test
// CHECK:  `- Return type: void
// CHECK:  `- Parameters:
// CHECK:    `-  type: s32, symbol: b
// CHECK:    `-  type: f32 [ 36 27 128 ], symbol: input
// CHECK:  `- Type Decl: ndims - [ 3 b ]
// CHECK:  `- Var Decl (s32): sum = 0
// CHECK:  `- Parallelization:  index symbol: p, bound [0, 6)
// CHECK:   `- With Block:
// CHECK:     (within constraints)
// CHECK:     `- index in ndims
// CHECK:     (with statements)
// CHECK:     `- Foreach Block:
// CHECK:      `- Iteration variables: index
// CHECK:      `- DMA.pad.async
// CHECK:        `- config: padding: low{1, 1}, high{0, 0}, mid{1, 0}, value: 1
// CHECK:        `- future: f
// CHECK:        `- from: input.ChunkAt(p, index)
// CHECK:        `- to: local
// CHECK:      `- DMA.pad
// CHECK:        `- config: padding: low{0, 0, 0}, high{0, 1, 2}, mid{1, 0, 3}, value: 0
// CHECK:        `- future: f1
// CHECK:        `- from: input.ChunkAt(p, index)
// CHECK:        `- to: local
// CHECK:      `- Assign: sum =  (sum + index(0))
// CHECK:      `- WAIT: f, f1
// CHECK:      `- Call: cfunction
// CHECK:        `- with arguments:  (dataof f) , (dataof f1)

__co__ void dma_test1(f32 [36, 27, 128] input) {
   f32 [9, 3, 8] dst;
   parallel p by 6 {
     with index in [5, 6] {
       dma.copy input.chunkat(p, index) => dst;
       f = dma.copy dst => local;
       dma.copy f.data => dst;
     }
   }
   return dst;
}

// CHECK: ChoreoFunction
// CHECK:  `- Name: dma_test1
// CHECK:  `- Return type: void
// CHECK:  `- Parameters:
// CHECK:    `-  type: f32 [ 36 27 128 ], symbol: input
// CHECK:  `- Var Decl (f32 [ 9 3 8 ], default): dst
// CHECK:  `- With Block:
// CHECK:    (within constraints)
// CHECK:    `- index in [ 5 6 ]
// CHECK:    (with statements)
// CHECK:    `- DMA.copy
// CHECK:      `- from: input.ChunkAt(p, index)
// CHECK:      `- to: dst
// CHECK:    `- DMA.copy
// CHECK:      `- future: f
// CHECK:      `- from: dst
// CHECK:      `- to: local
// CHECK:    `- DMA.copy
// CHECK:      `- from: f
// CHECK:      `- to: dst
// CHECK:  `- Return: dst

__co__ void dma_test2(f32 [27, 128] input) {
   with index in [5, 6] {
     f0 = dma.any;  // dummy dma
     foreach index {
        wait f0;
        f0 = dma.copy input.chunkat(index) => local;
     }
   }
   return dst;
}

// CHECK: ChoreoFunction
// CHECK:  `- Name: dma_test2
// CHECK:  `- Return type: void
// CHECK:  `- Parameters:
// CHECK:    `-  type: f32 [ 27 128 ], symbol: input
// CHECK:  `- With Block:
// CHECK:    (within constraints)
// CHECK:    `- index in [ 5 6 ]
// CHECK:    (with statements)
// CHECK:    `- DMA.any
// CHECK:    `- Foreach Block:
// CHECK:     `- Iteration variables: index
// CHECK:     `- WAIT: f0
// CHECK:     `- DMA.copy
// CHECK:       `- future: f0
// CHECK:       `- from: input.ChunkAt(index)
// CHECK:       `- to: local
// CHECK:  `- Return: dst

__co__ void dma_test3(f32 [36, 27, 128] input) {
   f32 [9, 3, 8] dst;
   with index in [5, 6] {
     foreach index {
        f0 = dma.transp<0, 2, 1> input.chunkat(p, index) => local;
        f1 = dma.transp.async<1, 2, 0> input.chunkat(p, index) => local;
        swap f0, f1;
        wait f1;
     }
   }
   return dst;
}

// CHECK: ChoreoFunction
// CHECK:  `- Name: dma_test3
// CHECK:  `- Return type: void
// CHECK:  `- Parameters:
// CHECK:    `-  type: f32 [ 36 27 128 ], symbol: input
// CHECK:  `- Var Decl (f32 [ 9 3 8 ], default): dst
// CHECK:  `- With Block:
// CHECK:    (within constraints)
// CHECK:    `- index in [ 5 6 ]
// CHECK:    (with statements)
// CHECK:    `- Foreach Block:
// CHECK:     `- Iteration variables: index
// CHECK:     `- DMA.transp
// CHECK:       `- future: f0
// CHECK:       `- from: input.ChunkAt(p, index)
// CHECK:       `- to: local
// CHECK:     `- DMA.transp.async
// CHECK:       `- future: f1
// CHECK:       `- from: input.ChunkAt(p, index)
// CHECK:       `- to: local
// CHECK:     `- Swap: f0, f1
// CHECK:     `- WAIT: f1
// CHECK:  `- Return: dst
