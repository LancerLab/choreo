// RUN: choreo -e %s | FileCheck --match-full-lines %s

__co__ auto select_parse(f32 [128, 128] i) {
  tile_factor : [32, 16];

  parallel p by 1 {
    with idx = {x_tile, y_tile} in [32, 16] {
      foreach x_tile, y_tile {
        i_shared = dma.copy.async i.chunkat(x_tile, y_tile) => shared;
        parallel q by 1{
          tile_factor_local : [1, 4];
          local f32 [i_shared.span / tile_factor_local] i_local0, i_local1, i_local2, i_local3;
          with idx = {p_tile, q_tile} in [1, 4] {
            i_local = dma.copy.async i_shared.chunkat(p_tile, q_tile) => select(q_tile % 4, i_local0, i_local1, i_local2, i_local3) after i_shared;
            i_local2 = dma.copy.async i_shared.chunkat(p_tile, q_tile) => select(q_tile % 2, i_local0, i_local1) after i_shared;
            f = select(1, i_local, i_local2);
          }
        }
      }
    }
  }
}

// CHECK:        `- DMA.copy.async
// CHECK:          `- future: i_local
// CHECK:          `- from: i_shared.ChunkAt(p_tile, q_tile)
// CHECK:          `- to: select( (q_tile % 4) , i_local0, i_local1, i_local2, i_local3)
// CHECK:          `- chained from: i_shared
// CHECK:        `- DMA.copy.async
// CHECK:          `- future: i_local2
// CHECK:          `- from: i_shared.ChunkAt(p_tile, q_tile)
// CHECK:          `- to: select( (q_tile % 2) , i_local0, i_local1)
// CHECK:          `- chained from: i_shared
// CHECK:        `- Var Decl (unknown): f = select(1, i_local, i_local2)

__co__ auto select2(f32 [128, 128] a, f16 [M, N] b) {
  c = select(0, a, b);
}

// CHECK:  `- Var Decl (unknown): c = select(0, a, b)
