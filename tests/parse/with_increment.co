// RUN: choreo -e %s | FileCheck %s --match-full-lines
// XFAIL: *

__co__ int with_foreach(int b, f32 [36, 27, 128] input) {
  ndims: [3, b];
  int sum = 0;
  parallel p by 6 {        // 'p' is bounded to [0, 6)
    with index in ndims {  // index is bounded to
      incr index while input.chunk_inbound(p, index) {
      }
    }
    with idx in [6] {
      with {m} in [3] {
        incr idx, m while true {
        }
      }
    }

  }
}

// CHECK: ChoreoFunction
// CHECK:  `- Name: with_foreach
// CHECK:  `- Return type: s32
// CHECK:  `- Parameters:
// CHECK:    `-  type: s32, symbol: b
// CHECK:    `-  type: f32 [ 36 27 128 ], symbol: input
// CHECK:  `- Type Decl: ndims - [ 3 b ]
// CHECK:  `- Var Decl (s32): sum = 0
// CHECK:  `- Parallelization:  index symbol: p, bound [0, 6)
// CHECK:   `- With Block:
// CHECK:     (within constraints)
// CHECK:     `- index in ndims
// CHECK:     (with statements)
// CHECK:     `- Increment Block:
// CHECK:      `- Iteration variables: index
// CHECK:      `- Predicate:  (inbound input.ChunkAt(p, index))
// CHECK:   `- With Block:
// CHECK:     (within constraints)
// CHECK:     `- idx in [ 6 ]
// CHECK:     (with statements)
// CHECK:     `- With Block:
// CHECK:       (within constraints)
// CHECK:       `-  {m} in [ 3 ]
// CHECK:       (with statements)
// CHECK:       `- Increment Block:
// CHECK:        `- Iteration variables: idx, m
// CHECK:        `- Predicate: true
