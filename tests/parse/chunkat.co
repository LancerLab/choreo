// RUN: choreo -e %s | FileCheck %s

__co__ void foo(f32 [M, N] data) {
  with {x, y} in [M/3, N/2] {
    dma.copy data.chunk(3, 2).at(x, y) => global;
  }
}

// CHECK: ChoreoFunction
// CHECK:  `- Name: foo
// CHECK:  `- Return type: void
// CHECK:  `- Parameters:
// CHECK:    `-  type: f32 [ M N ], symbol: data
// CHECK:  `- With Block:
// CHECK:    (within constraints)
// CHECK:    `- {x, y} in [ (M / 3)  (N / 2)  ]
// CHECK:    (with statements)
// CHECK:    `- DMA.copy
// CHECK:      `- from: data.Chunk(3, 2).At(x, y)
// CHECK:      `- to: global

__co__ void bar(f32 [7, 4] data) {
  with {x, y} in data.span {
    call foobar(data.chunkat(x, y));
  }
}

// CHECK:    `- Call: foobar
// CHECK:      `- with arguments: data.ChunkAt(x, y)

__co__ void wow() {
  f32 [7] data[2];
  with {x} in data.span {
    dma.copy data[0].chunkat(x) => local;
    call foobar(data[1].chunkat(x));
  }
}

// CHECK:    `- DMA.copy
// CHECK:      `- from: data[0].ChunkAt(x)
// CHECK:      `- to: local
// CHECK:    `- Call: foobar
// CHECK:      `- with arguments: data[1].ChunkAt(x)

__co__ void cow(f32 [9] inp) {
  with {x} in [3] {
    dma.copy inp.subspan(3).at(x) => local;
    dma.copy inp.chunk(3).at(x) => local;
    dma.copy inp.modspan(3).at(x) => local;
  }
}

// CHECK:    `- DMA.copy
// CHECK:      `- from: inp.SubSpan(3).At(x)
// CHECK:      `- to: local
// CHECK:    `- DMA.copy
// CHECK:      `- from: inp.Chunk(3).At(x)
// CHECK:      `- to: local
// CHECK:    `- DMA.copy
// CHECK:      `- from: inp.ModSpan(3).At(x)
// CHECK:      `- to: local

__co__ void mow(f32 [9] inp) {
  with {x} in [3] {
    dma.copy inp.subspan(3).at(x).modspan(4).at(x).chunkat(x) => local;
  }
}

// CHECK:    `- DMA.copy
// CHECK:      `- from: inp.SubSpan(3).At(x).ModSpan(4).At(x).ChunkAt(x)
// CHECK:      `- to: local

__co__ void baz(f32 [4, 8, 64] i) {
  parallel p by 4 {
    foreach x in [2]
      dma.copy i.subspan(4/#p, 8/#x, 64) => local;
    foreach {x, y} in [2, 4]
      dma.copy i.subspan(4/#p, 8/#x, 64/#y) => local;
  }
}

// CHECK: from: i.SubSpan( (4 /  (ubound p) ) ,  (8 /  (ubound x) ) , 64).At(0, 0, 0)
// CHECK: from: i.SubSpan( (4 /  (ubound p) ) ,  (8 /  (ubound x) ) ,  (64 /  (ubound y) ) ).At(0, 0, 0)
