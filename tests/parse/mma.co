// RUN: choreo -e %s | FileCheck --match-full-lines %s

__co__ s32 [128, 256] matmul(s32 [128, 256] lhs, s32 [256, 256] rhs) {
  s32[lhs.span(0), rhs.span(1)] output;

  parallel p by 1, q by 16
    mc = mma.fill 0;
    foreach k in [16] {
      ma = mma.load lhs.chunkat(p, k);
      mb = mma.load rhs.chunkat(k, q);
      mma.row.col mc, ma, mb;
      mma.store mc, output.chunkat(p, q);
    }
  return output;
}


// CHECK:    `- mc = MMA.FILL 0
// CHECK:     `- ma = MMA.LOAD lhs.Chunk( (ubound p) , (ubound k) ).At(p, k)
// CHECK:     `- mb = MMA.LOAD rhs.Chunk( (ubound k) , (ubound q) ).At(k, q)
// CHECK:     `- MMA.EXEC.ROW.COL mc, ma, mb
// CHECK:     `- MMA.STORE mc, output.Chunk( (ubound p) , (ubound q) ).At(p, q)
