// RUN: choreo -vn %s | FileCheck --check-prefix=CHKVN %s
// RUN: choreo -i %s | FileCheck --check-prefix=CHKINF %s

__co__ void foo(f32 [M, N] data, int b) {
  with {x, y} in [M/3, N/2] {
    dma.copy data.chunk(7, 8).at(x, y) => global;
  }
  parallel p by 3 {
    f = dma.copy data.chunk(b, 5).at(p, p) => local;
  }
}

// CHKVN:    New VN [[FOO_M:#[0-9]+]]: '::foo::M'
// CHKVN:    New VN [[FOO_N:#[0-9]+]]: '::foo::N'
// CHKVN:    New VN [[FOO_b:#[0-9]+]]: '::foo::b'
// CHKVN:    scope-2 {
// CHKVN:     New VN [[CON7:#[0-9]+]]: 'const_7'
// CHKVN:     New VN [[CON8:#[0-9]+]]: 'const_8'
// CHKVN:     New VN #{{[0-9]+}}: '/:[[FOO_M]]:[[CON7]]'
// CHKVN:     New VN #{{[0-9]+}}: '/:[[FOO_N]]:[[CON8]]'
// CHKVN:    } // end scope-2
// CHKVN:    scope-2 {
// CHKVN:     New VN [[CON5:#[0-9]+]]: 'const_5'
// CHKVN:     New VN #{{[0-9]+}}: '/:[[FOO_M]]:[[FOO_b]]'
// CHKVN:     New VN #{{[0-9]+}}: '/:[[FOO_N]]:[[CON5]]'
// CHKVN:    } // end scope-2
// CHKVN:   } // end scope-1

// CHKINF: Parameter: ::foo::data, Type: f32 mdspan<2> [::foo::M, ::foo::N]
// CHKINF: Parameter: ::foo::b, Type: s32
// CHKINF: Bounded:   ::foo::within_0::x, Type: {int}->[(::foo::M / 3)]
// CHKINF: Bounded:   ::foo::within_0::y, Type: {int}->[(::foo::N / 2)]
// CHKINF: Future:    ::foo::within_0::(anon), Type: sync=>global f32 mdspan<2> [(::foo::M / 7), (::foo::N / 8)]
// CHKINF: Bounded:   ::foo{{(::paraby_[0-9]+)*}}::p, Type: {int}->[3]
// CHKINF: Bounded:   ::foo{{(::paraby_[0-9]+)*}}::p__elem__x, Type: {int}->[3]
// CHKINF: Future:    ::foo{{(::paraby_[0-9]+)*}}::f, Type: sync=>local f32 mdspan<2> [(::foo::M / ::foo::b), (::foo::N / 5)]
// CHKINF: Function:  ::foo, Type: void (*)(f32 mdspan<2> [::foo::M, ::foo::N], s32)

__co__ void bar(f32 [32, 76] data, s8 [128] d2, int b) {
  parallel {p0, p1} by [3, 4]
    with {x, y} in [6, 3] {
      f0 = dma.copy data.chunk(b, 2).at(p0, p1) => local;
      f1 = dma.copy data.subspan(31, 33).at(x, y).modspan(7, 6).at(p0, p1) => local;
      f2 = dma.copy d2.modspan(37).at(x).chunkat(_).subspan(16).at(y) => local;
    }
}

// CHECKINF: Parameter: ::bar::data, Type: f32 mdspan<2> [32, 76]
// CHECKINF: Parameter: ::bar::d2, Type: s8 mdspan<1> [128]
// CHECKINF: Parameter: ::bar::b, Type: s32
// CHECKINF: Bounded:   ::bar{{(::paraby_[0-9]+)*}}::anon_0, Type: {int,int}->[3, 4]
// CHECKINF: Bounded:   ::bar{{(::paraby_[0-9]+)*}}::p0, Type: {int}->[3](pi:x)
// CHECKINF: Bounded:   ::bar{{(::paraby_[0-9]+)*}}::p1, Type: {int}->[4](pi:y)
// CHECKINF: Bounded:   ::bar{{(::paraby_[0-9]+)*}}::within_1::x, Type: {int}->[6]
// CHECKINF: Bounded:   ::bar{{(::paraby_[0-9]+)*}}::within_1::y, Type: {int}->[3]
// CHECKINF: Future:    ::bar{{(::paraby_[0-9]+)*}}::within_1::f0, Type: sync=>local f32 mdspan<2> [(32 / ::bar::b), 38]
// CHECKINF: Future:    ::bar{{(::paraby_[0-9]+)*}}::within_1::f1, Type: sync=>local f32 mdspan<2> [3, 3]
// CHECKINF: Future:    ::bar{{(::paraby_[0-9]+)*}}::within_1::f2, Type: sync=>local s8 mdspan<1> [16]
// CHECKINF: Function:  ::bar, Type: void (*)(f32 mdspan<2> [32, 76], s8 mdspan<1> [128], s32)
