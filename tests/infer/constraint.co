// RUN: choreo -i %s | FileCheck --match-full-lines %s

__co__ s32 [6, 17, 128] ele_add(s32 [6, 17, 128] lhs) {
  s32[lhs.span] output;

  parallel p by 6 {
    with index = {x, y} in [17, 4] {
      local s32 [lhs.span / {#p, #x, #y}] l_out; 

      foreach x {
        A = dma.any;
        B = dma.any;
        C = dma.any;
        D = dma.any;
        foreach y(1:) {
          E = dma.copy.async lhs.chunkat(p, x, y) => local;
          F = dma.any;

          // establish constraint and propagate
          swap(A, D);
          swap(C, B);
          swap(F, C);
          swap(E, F);
        }
        // establish constraint and propagate
        lf = select(#y % 2, C, A);
      }
    }
  }

  return output;
}

// CHECK: Parameter: ::ele_add::lhs, Type: s32 mdspan<3> [6, 17, 128]
// CHECK: Symbol:    ::ele_add::output, Type: global s32 mdspan<3> [6, 17, 128]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::p, Type: {int}->[6]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::index, Type: {int,int}->[17, 4]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::x, Type: {int}->[17]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::y, Type: {int}->[4]
// CHECK: Symbol:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::l_out, Type: local s32 mdspan<3> [1, 1, 32]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::foreach_1::E, Type: async=>local s32 mdspan<3> [1, 1, 32]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::foreach_1::F, Type: async=>local s32 mdspan<3> [1, 1, 32]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::C, Type: async=>local s32 mdspan<3> [1, 1, 32]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::B, Type: async=>local s32 mdspan<3> [1, 1, 32]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::A, Type: async=>local s32 mdspan<3> [1, 1, 32]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::D, Type: async=>local s32 mdspan<3> [1, 1, 32]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::lf, Type: async=>local s32 mdspan<3> [1, 1, 32]
// CHECK: Function:  ::ele_add, Type: s32 mdspan<3> [6, 17, 128] (*)(s32 mdspan<3> [6, 17, 128])
