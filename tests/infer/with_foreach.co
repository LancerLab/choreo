// RUN: choreo -i %s | FileCheck --match-full-lines %s

#include "choreo.h"

__co__ void with_foreach(s32 [6, 128] lhs, s32 [128] rhs) {
  with index={m} in [32] {
    foreach m {}
  }
// CHECK: Bounded:   ::with_foreach::within_0::index, Type: {int}->[32]
// CHECK: Bounded:   ::with_foreach::within_0::m, Type: {int}->[32]

  // These two methods are exactly the same
  with index={m, n} in [32, 128] {
    foreach m, n {}
  }
  with index={m, n} in [32, 128] {
    foreach index {}
  }
// CHECK: Bounded:   ::with_foreach::within_1::index, Type: {int,int}->[32, 128]
// CHECK: Bounded:   ::with_foreach::within_1::m, Type: {int}->[32]
// CHECK: Bounded:   ::with_foreach::within_1::n, Type: {int}->[128]
// CHECK: Bounded:   ::with_foreach::within_2::index, Type: {int,int}->[32, 128]
// CHECK: Bounded:   ::with_foreach::within_2::m, Type: {int}->[32]
// CHECK: Bounded:   ::with_foreach::within_2::n, Type: {int}->[128]

  with index in [32, 128] {
    foreach index {}
  }
// CHECK: Bounded:   ::with_foreach::within_3::index, Type: {int,int}->[32, 128]
// CHECK: Bounded:   ::with_foreach::within_3::index__elem__0, Type: {int}->[32]
// CHECK: Bounded:   ::with_foreach::within_3::index__elem__1, Type: {int}->[128]

  with index in [32] {
    foreach index {
      rhs_load = dma.copy rhs.chunkat(index) => global;
    }
  }
// CHECK: Bounded:   ::with_foreach::within_4::index, Type: {int}->[32]
// CHECK: Bounded:   ::with_foreach::within_4::index__elem__0, Type: {int}->[32]
// CHECK: Future:    ::with_foreach::within_4::foreach_4::rhs_load, Type: sync=>global s32 mdspan<1> [4]

  with {m} in [32] {
    foreach m {}
  }
// CHECK: Bounded:   ::with_foreach::within_5::m, Type: {int}->[32]

  parallel p by 1{
    with index in [6, 32] {
      foreach index {
        lhs_load = dma.copy lhs.chunkat(index) => local;
      }
    }
  }
// CHECK: Bounded:   ::with_foreach{{(::paraby_[0-9]+)*}}::p, Type: {int}->[1]
// CHECK: Bounded:   ::with_foreach{{(::paraby_[0-9]+)*}}::within_6::index, Type: {int,int}->[6, 32]
// CHECK: Bounded:   ::with_foreach{{(::paraby_[0-9]+)*}}::within_6::index__elem__0, Type: {int}->[6]
// CHECK: Bounded:   ::with_foreach{{(::paraby_[0-9]+)*}}::within_6::index__elem__1, Type: {int}->[32]
// CHECK: Future:    ::with_foreach{{(::paraby_[0-9]+)*}}::within_6::foreach_6::lhs_load, Type: sync=>local s32 mdspan<2> [1, 4]

  parallel p by 1 {
    int bb = |lhs.span|;
    with idx0 in 3 {
      with idx1 in bb {
        foreach idx0, idx1 {}
      }
    }
  }
// CHECK: Symbol:    ::with_foreach{{(::paraby_[0-9]+)*}}::bb, Type: s32
// CHECK: Bounded:   ::with_foreach{{(::paraby_[0-9]+)*}}::within_7::idx0, Type: {int}->[3]
// CHECK: Bounded:   ::with_foreach{{(::paraby_[0-9]+)*}}::within_7::idx0__elem__0, Type: {int}->[3]
// CHECK: Bounded:   ::with_foreach{{(::paraby_[0-9]+)*}}::within_7::within_8::idx1, Type: {int}->[768]
// CHECK: Bounded:   ::with_foreach{{(::paraby_[0-9]+)*}}::within_7::within_8::idx1__elem__0, Type: {int}->[768]


}

