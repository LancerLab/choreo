// RUN: choreo -i %s | FileCheck --match-full-lines %s

#include "choreo.h"

__co__ auto ele_add(s32 [6, ?, 128] lhs, s32 [6, ?, 128] rhs) {
  s32[lhs.span] output;

  parallel p by 6 {
    with idx0 = {q, x, y} in lhs.span / {#p, 2, 32}, // [6/6, lhs.span(1) / 2, 128/32] = [1, lhs.span(1) / 2, 4 ]
         idx1 = {w, z, b} in rhs.span / {#p, 2, 32}
    where x <-> z {
      foreach idx0 {
        lhs_load = dma.copy lhs.chunkat(q, x, y) => local;
        rhs_load = dma.copy rhs.chunkat(w, z, b) => local;

        local s32[lhs_load.span] l1_out;
        call kernel(lhs_load.data, rhs_load.data, l1_out, |lhs_load.span|);

        out_store = dma.copy l1_out => output.chunkat(q,x,y);
      }
    }
  }
  return output;
}

// CHECK: Parameter: ::ele_add::lhs, Type: s32 mdspan<3> [6, ::ele_add::$0, 128]
// CHECK: Parameter: ::ele_add::rhs, Type: s32 mdspan<3> [6, ::ele_add::$1, 128]
// CHECK: Symbol:    ::ele_add::output, Type: global s32 mdspan<3> [6, ::ele_add::$0, 128]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::p, Type: {int}->[6]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::idx0, Type: {int,int,int}->[1, (::ele_add::$0 / 2), 4]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::q, Type: {int}->[1]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::x, Type: {int}->[(::ele_add::$0 / 2)]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::y, Type: {int}->[4]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::idx1, Type: {int,int,int}->[1, (::ele_add::$1 / 2), 4]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::w, Type: {int}->[1]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::z, Type: {int}->[(::ele_add::$1 / 2)]
// CHECK: Bounded:   ::ele_add{{(::paraby_[0-9]+)*}}::within_0::b, Type: {int}->[4]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::lhs_load, Type: sync=>local s32 mdspan<3> [6, 2, 32]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::rhs_load, Type: sync=>local s32 mdspan<3> [6, 2, 32]
// CHECK: Symbol:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::l1_out, Type: local s32 mdspan<3> [6, 2, 32]
// CHECK: Future:    ::ele_add{{(::paraby_[0-9]+)*}}::within_0::foreach_0::out_store, Type: sync=>global s32 mdspan<3> [6, 2, 32]
// CHECK: Function:  ::ele_add, Type: s32 mdspan<3> [6, ::ele_add::$0, 128] (*)(s32 mdspan<3> [6, ::ele_add::$0, 128], s32 mdspan<3> [6, ::ele_add::$1, 128])
