// RUN: choreo -i %s | FileCheck --match-full-lines %s

// device program
__co__ s32 mdspan<3> spms(s32 [20, 42, 80] a, s32 mdspan<1> b) {
  f32[a.span] global_buffer;   // [20, 42, 80]

  parallel p by 2 {
    shared f32 [a.span(1), 4] shared_buffer;  // [42, 4]
    parallel q by 6 {
      with index = {x, y} in [10, 20] {
        foreach x {
          f1 = dma.copy a.chunkat(p, q, x) => local; // [20/2, 42/6, 80/10]
          f2 = dma.transp<2, 0, 1> a.chunkat(p, q, x) => local; // [8, 10, 7]
          local f32[f1.span] local_buffer;  // [10, 7, 8]
          local f32[f2.span] local_buffer_2;
        }
      }
    }
    // end kernel function
  }

  return global_buffer;
}

// CHECK: Parameter: ::spms::a, Type: s32 mdspan<3> [20, 42, 80]
// CHECK: Parameter: ::spms::b, Type: s32 mdspan<1> [::spms::$0]
// CHECK: Symbol:    ::spms::global_buffer, Type: global f32 mdspan<3> [20, 42, 80]
// CHECK: Bounded:   ::spms{{(::paraby_[0-9]+)*}}::p, Type: {int}->[2]
// CHECK: Symbol:    ::spms{{(::paraby_[0-9]+)*}}::shared_buffer, Type: shared f32 mdspan<2> [42, 4]
// CHECK: Bounded:   ::spms{{(::paraby_[0-9]+)*}}::q, Type: {int}->[6]
// CHECK: Bounded:   ::spms{{(::paraby_[0-9]+)*}}::within_0::index, Type: {int,int}->[10, 20]
// CHECK: Bounded:   ::spms{{(::paraby_[0-9]+)*}}::within_0::x, Type: {int}->[10]
// CHECK: Bounded:   ::spms{{(::paraby_[0-9]+)*}}::within_0::y, Type: {int}->[20]
// CHECK: Future:    ::spms{{(::paraby_[0-9]+)*}}::within_0::foreach_0::f1, Type: sync=>local s32 mdspan<3> [10, 7, 8]
// CHECK: Future:    ::spms{{(::paraby_[0-9]+)*}}::within_0::foreach_0::f2, Type: sync=>local s32 mdspan<3> [8, 10, 7]
// CHECK: Symbol:    ::spms{{(::paraby_[0-9]+)*}}::within_0::foreach_0::local_buffer, Type: local f32 mdspan<3> [10, 7, 8]
// CHECK: Symbol:    ::spms{{(::paraby_[0-9]+)*}}::within_0::foreach_0::local_buffer_2, Type: local f32 mdspan<3> [8, 10, 7]
// CHECK: Function:  ::spms, Type: f32 mdspan<3> [20, 42, 80] (*)(s32 mdspan<3> [20, 42, 80], s32 mdspan<1> [::spms::$0])
