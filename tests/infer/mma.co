// RUN: choreo -t cute -i %s | FileCheck --match-full-lines %s

__co__ s32 [128, 256] matmul(s32 [128, 256] lhs, s32 [256, 256] rhs) {
  s32[lhs.span(0), rhs.span(1)] output;

  int MMA_M = 16, MMA_N = 16, MMA_K = 16;

  parallel p by 1 : block
    parallel {q0, q1} by [lhs.span(0) / MMA_K, rhs.span(1) / MMA_N] : group {
      mc = mma.fill 0;
      foreach k in [lhs.span(0) / MMA_K] {
        ma = mma.load lhs.chunkat(q0, k);
        mb = mma.load rhs.chunkat(k, q1);
        mma.row.col mc, ma, mb;   // row * col
        mma.store mc, output.chunkat(q0, q1);
      }
    }
  return output;
}

// CHECK: Future:    ::matmul{{(::paraby_[0-9]+)*}}::within_0::foreach_0::ma, Type: sync=>register s32 mdspan<2> [16, 32]
// CHECK: Future:    ::matmul{{(::paraby_[0-9]+)*}}::within_0::foreach_0::mb, Type: sync=>register s32 mdspan<2> [32, 16]
// CHECK: Symbol:    ::matmul{{(::paraby_[0-9]+)*}}::mc, Type: register s32 mdspan<2> [16, 16]
