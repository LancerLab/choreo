// RUN: choreo -i %s | FileCheck --match-full-lines %s

__co__ auto subspan(s32 [32, 18, 9] a) {
  f32 [a.span] b;
  parallel p by 3 {
    bshape = {16, 18};
    cshape = {bshape, a.span(2) / #p};
    dshape = {12, 7};
    with index = {x, y} in [4, 4] {
      foreach index {
        f = dma.copy a.subspan(2, 2, 1).at(x, p, y) => local;
        g = dma.copy b.subspan(4, 9, 3).at(p, p, x) => local;
        h = dma.copy f.subspan(_, 2, _).at(0, 0, 0) => shared;
        i = dma.copy a.subspan(bshape, 9).at(index, p) => shared;
        j = dma.copy b.subspan(cshape).at(x, y, p) => shared;
        k = dma.copy b.chunk(cshape).at(index, p) => shared;
        l = dma.copy b.modspan(3, 7, 4).at(index, p) => shared;
        m = dma.copy b.modspan(9, dshape).at(x, y, p) => shared;
      }
    }
  }
}

// CHECK: Parameter: ::subspan::a, Type: s32 mdspan<3> [32, 18, 9]
// CHECK: Symbol:    ::subspan::b, Type: global f32 mdspan<3> [32, 18, 9]
// CHECK: Bounded:   ::subspan{{(::paraby_[0-9]+)*}}::anon_pb_0, Type: {int}->[1]
// CHECK: Bounded:   ::subspan{{(::paraby_[0-9]+)*}}::anon_pb_0__elem__x, Type: {int}->[1](pi:x)
// CHECK: Bounded:   ::subspan{{(::paraby_[0-9]+)*}}::p, Type: {int}->[3]
// CHECK: Bounded:   ::subspan{{(::paraby_[0-9]+)*}}::p__elem__x, Type: {int}->[3](pi:x)
// CHECK: Symbol:    ::subspan{{(::paraby_[0-9]+)*}}::bshape, Type: ituple<2>
// CHECK: Symbol:    ::subspan{{(::paraby_[0-9]+)*}}::cshape, Type: ituple<3>
// CHECK: Symbol:    ::subspan{{(::paraby_[0-9]+)*}}::dshape, Type: ituple<2>
// CHECK: Bounded:   ::subspan{{(::paraby_[0-9]+)*}}::within_0::index, Type: {int,int}->[4, 4]
// CHECK: Bounded:   ::subspan{{(::paraby_[0-9]+)*}}::within_0::x, Type: {int}->[4]
// CHECK: Bounded:   ::subspan{{(::paraby_[0-9]+)*}}::within_0::y, Type: {int}->[4]
// CHECK: Future:    ::subspan{{(::paraby_[0-9]+)*}}::within_0::foreach_0::f, Type: sync=>local s32 mdspan<3> [2, 2, 1]
// CHECK: Future:    ::subspan{{(::paraby_[0-9]+)*}}::within_0::foreach_0::g, Type: sync=>local f32 mdspan<3> [4, 9, 3]
// CHECK: Future:    ::subspan{{(::paraby_[0-9]+)*}}::within_0::foreach_0::h, Type: sync=>shared s32 mdspan<3> [2, 2, 1]
// CHECK: Future:    ::subspan{{(::paraby_[0-9]+)*}}::within_0::foreach_0::i, Type: sync=>shared s32 mdspan<3> [16, 18, 9]
// CHECK: Future:    ::subspan{{(::paraby_[0-9]+)*}}::within_0::foreach_0::j, Type: sync=>shared f32 mdspan<3> [16, 18, 3]
// CHECK: Future:    ::subspan{{(::paraby_[0-9]+)*}}::within_0::foreach_0::k, Type: sync=>shared f32 mdspan<3> [2, 1, 3]
// CHECK: Future:    ::subspan{{(::paraby_[0-9]+)*}}::within_0::foreach_0::l, Type: sync=>shared f32 mdspan<3> [2, 4, 1]
// CHECK: Future:    ::subspan{{(::paraby_[0-9]+)*}}::within_0::foreach_0::m, Type: sync=>shared f32 mdspan<3> [5, 6, 2]
// CHECK: Function:  ::subspan, Type: void (*)(s32 mdspan<3> [32, 18, 9])
