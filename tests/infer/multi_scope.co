// RUN: choreo -i %s | FileCheck --match-full-lines %s
// RUN: choreo -vn %s | FileCheck --check-prefix=VALNO --match-full-lines %s

// choreo program
__co__ void foo(f32 [2, 3, 4] d, int e) {
  int f = 4;
  a : [ 5, 1, d.span(2) / 3 ];       // [5, 1, 1]
  b : [ a(2), e + 1, 7 * 3 - 1 ];    // [1, e + 1, 20]
  c = { a(0), b(1) + 4, f};          // {5, e + 5, 4}
  parallel p by 6 {
    a : [ 25, 1, e ];                // [25, 1, e]
    with g in [3] {
      b : a[ (0) / 5, 3 + b(2) ];   // [5, 23] (not [1, 23])
      f = 5;                  // f is in another scope
      call abc(5);
      //c : [c(1) + 1, b(0)];
    }
  }
//  f : (c + {2, 3}) / {3, 2};         // [1, 13]
}

// VALNO:  scope-1 {
// VALNO:   New VN #0: 'const_1'
// VALNO:   Alias "::@__choreo_no_tiling__" -> #0
// VALNO:   New VN #1: 'const_0'
// VALNO:   Alias "::__choreo_no_tiling__" -> #1
// VALNO:   New VN #2: '::__choreo_parent_dim__'
// VALNO:   New VN #3: 'const_2'
// VALNO:   New VN #4: 'const_3'
// VALNO:   New VN #5: 'const_4'
// VALNO:   New VN #6: '#3,#4,#5'
// VALNO:   Alias "::foo::d.span" -> #6
// VALNO:   New VN #7: '::foo::e'
// VALNO:   Alias "::foo::f" -> #5
// VALNO:   New VN #8: 'const_5'
// VALNO:   New VN #9: '#8,#0,#0'
// VALNO:   Alias "::foo::a" -> #9
// VALNO:   New VN #10: '+:#7:#0'
// VALNO:   New VN #11: 'const_7'
// VALNO:   New VN #12: 'const_21'
// VALNO:   New VN #13: 'const_20'
// VALNO:   New VN #14: '#0,#10,#13'
// VALNO:   Alias "::foo::b" -> #14
// VALNO:   New VN #15: '+:#7:#8'
// VALNO:   New VN #16: '#8,#15,#5'
// VALNO:   Alias "::foo::c" -> #16
// VALNO:     New VN #[[vn0:[0-9]+]]: 'const_6'
// VALNO:     Alias "::foo{{(::paraby_[0-9]+)*}}::@p" -> #[[vn0]]
// VALNO:     New VN #[[vn1:[0-9]+]]: '::foo{{(::paraby_[0-9]+)*}}::p'
// VALNO:     Alias "::foo{{(::paraby_[0-9]+)*}}::@p__elem__x" -> #[[vn0]]
// VALNO:     New VN #[[vn2:[0-9]+]]: '::foo{{(::paraby_[0-9]+)*}}::p__elem__x'
// VALNO:     New VN #[[vn3:[0-9]+]]: 'const_25'
// VALNO:     New VN #[[vn4:[0-9]+]]: '#[[vn3]],#0,#7'
// VALNO:     Alias "::foo{{(::paraby_[0-9]+)*}}::a" -> #[[vn4]]
// VALNO:      Alias "::foo{{(::paraby_[0-9]+)*}}::within_0::@g(0)" -> #4
// VALNO:      Alias "::foo{{(::paraby_[0-9]+)*}}::within_0::@g__elem__0" -> #4
// VALNO:      New VN #[[vn5:[0-9]+]]: '::foo{{(::paraby_[0-9]+)*}}::within_0::g__elem__0'
// VALNO:      New VN #[[vn6:[0-9]+]]: '::foo{{(::paraby_[0-9]+)*}}::within_0::g'
// VALNO:      Alias "::foo{{(::paraby_[0-9]+)*}}::within_0::@g" -> #4
// VALNO:      New VN #[[vn7:[0-9]+]]: 'const_23'
// VALNO:      New VN #[[vn8:[0-9]+]]: '#8,#[[vn7]]'
// VALNO:      Alias "::foo{{(::paraby_[0-9]+)*}}::within_0::b" -> #[[vn8]]
// VALNO:      Alias "::foo{{(::paraby_[0-9]+)*}}::within_0::f" -> #8
// VALNO:  } // end scope-1

// CHECK: Parameter: ::foo::d, Type: f32 mdspan<3> [2, 3, 4]
// CHECK: Parameter: ::foo::e, Type: s32
// CHECK: Symbol:    ::foo::f, Type: s32
// CHECK: Partial:   ::foo::a, Type: mdspan<3> [5, 1, 1]
// CHECK: Partial:   ::foo::b, Type: mdspan<3> [1, (::foo::e + 1), 20]
// CHECK: Symbol:    ::foo::c, Type: ituple<3>
// CHECK: Partial:   ::foo{{(::paraby_[0-9]+)*}}::a, Type: mdspan<3> [25, 1, ::foo::e]
// CHECK: Partial:   ::foo{{(::paraby_[0-9]+)*}}::within_0::b, Type: mdspan<2> [5, 23]
// CHECK: Symbol:    ::foo{{(::paraby_[0-9]+)*}}::within_0::f, Type: s32
