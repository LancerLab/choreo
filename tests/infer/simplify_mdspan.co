// RUN: choreo -i %s | FileCheck --match-full-lines %s
// RUN: choreo -vn %s | FileCheck --check-prefix=VALNO --match-full-lines %s

// recognize the __co__ function

#include <iostream>

// device program
__co__ void foo(f32 [2, 3, 4] d, int e) {
  a : [ 5, 1, d.span(2) / 3 ];       // [5, 1, 1]
  b : [ a(2), e + 1, 7 * 3 - 1 ];    // [1, e + 1, 20]
  c : a [ (0) / 5, 3 + b(2) ];       // [1, 23]
//  f : (c + {2, 3}) / {3, 2};         // [1, 13]
}

// VALNO:  scope-1 {
// VALNO:   New VN #0: 'const_1'
// VALNO:   Alias "::@__choreo_no_tiling__" -> #0
// VALNO:   New VN #1: '::__choreo_no_tiling__'
// VALNO:   New VN #2: 'const_2'
// VALNO:   New VN #3: 'const_3'
// VALNO:   New VN #4: 'const_4'
// VALNO:   New VN #5: '#2,#3,#4'
// VALNO:   Alias "::foo::d.span" -> #5
// VALNO:   New VN #6: '::foo::e'
// VALNO:   New VN #7: 'const_5'
// VALNO:   New VN #8: '#7,#0,#0'
// VALNO:   Alias "::foo::a" -> #8
// VALNO:   New VN #9: '+:#6:#0'
// VALNO:   New VN #10: 'const_7'
// VALNO:   New VN #11: 'const_21'
// VALNO:   New VN #12: 'const_20'
// VALNO:   New VN #13: '#0,#9,#12'
// VALNO:   Alias "::foo::b" -> #13
// VALNO:   New VN #14: 'const_0'
// VALNO:   New VN #15: 'const_23'
// VALNO:   New VN #16: '#0,#15'
// VALNO:   Alias "::foo::c" -> #16
// VALNO:  } // end scope-1

// CHECK: Parameter: ::foo::d, Type: f32 mdspan<3> [2, 3, 4]
// CHECK: Parameter: ::foo::e, Type: s32
// CHECK: Partial:   ::foo::a, Type: mdspan<3> [5, 1, 1]
// CHECK: Partial:   ::foo::b, Type: mdspan<3> [1, (::foo::e + 1), 20]
// CHECK: Partial:   ::foo::c, Type: mdspan<2> [1, 23]
