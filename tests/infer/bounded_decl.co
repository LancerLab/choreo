// RUN: choreo -i %s | FileCheck --match-full-lines %s
// RUN: choreo -vn -dv=valno %s | FileCheck --check-prefix=CHKVALNO --match-full-lines %s

__co__ void bounded_decls(s32 [160, 27, 9] input) {
  parallel p by 2, q by 4 {
    foreach {x, y} in [3, 9] {
      q1 = q #- 1;
      pq1 = p # q1;
      p_q1 = p # (q #- 1);
      pq_1 = p # q #- 1;
      pqx = p # q # x;

      dma.copy input.chunkat(p#q1#x, p#q#+1, x-1) => local;
      dma.copy input.chunkat(pq1 + 1, p_q1, pq_1) => local;
      dma.copy input.chunkat(pqx, _, y) => local;
    }
  }
}

// CHKVALNO: <Bounded> ' (q #- 1) 's ubound: 'const_3'
// CHKVALNO: <Bounded> ' (p # q1) 's ubound: 'const_6'
// CHKVALNO: <Bounded> ' (p # q) 's ubound: 'const_8'
// CHKVALNO: <Bounded> ' ( (p # q)  #- 1) 's ubound: 'const_7'
// CHKVALNO: <Bounded> ' (p # q) 's ubound: 'const_8'
// CHKVALNO: <Bounded> ' ( (p # q)  # x) 's ubound: 'const_24'
// CHKVALNO: <Bounded> ' (p # q1) 's ubound: 'const_6'
// CHKVALNO: <Bounded> ' ( (p # q1)  # x) 's ubound: 'const_18'
// CHKVALNO: <Bounded> ' (p # q) 's ubound: 'const_8'
// CHKVALNO: <Bounded> ' ( (p # q)  #+ 1) 's ubound: 'const_9'
// CHKVALNO: <Bounded> ' (x - 1) 's ubound: 'const_3'
// CHKVALNO: <Bounded> ' (pq1 + 1) 's ubound: 'const_6'

// CHECK: Parameter: ::bounded_decls::input, Type: s32 mdspan<3> [160, 27, 9]
// CHECK: Bounded:   ::bounded_decls{{(::paraby_[0-9]+)*}}::p, Type: {int}->[2]
// CHECK: Bounded:   ::bounded_decls{{(::paraby_[0-9]+)*}}::p__elem__x, Type: {int}->[2](pi:x)
// CHECK: Bounded:   ::bounded_decls{{(::paraby_[0-9]+)*}}::q, Type: {int}->[4]
// CHECK: Bounded:   ::bounded_decls{{(::paraby_[0-9]+)*}}::q__elem__x, Type: {int}->[4](pi:x)
// CHECK: Bounded:   ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::x, Type: {int}->[3]
// CHECK: Bounded:   ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::y, Type: {int}->[9]
// CHECK: Symbol:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::q1, Type: {int}->[3]
// CHECK: Symbol:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::pq1, Type: {int}->[6]
// CHECK: Symbol:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::p_q1, Type: {int}->[6]
// CHECK: Symbol:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::pq_1, Type: {int}->[7]
// CHECK: Symbol:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::pqx, Type: {int}->[24]
// CHECK: Symbol:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::anon_0, Type: {int}->[18]
// CHECK: Symbol:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::anon_1, Type: {int}->[9]
// CHECK: Symbol:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::anon_2, Type: {int}->[3]
// CHECK: Future:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::(anon), Type: sync=>local s32 mdspan<3> [8, 3, 3]
// CHECK: Symbol:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::anon_3, Type: {int}->[6]
// CHECK: Future:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::(anon), Type: sync=>local s32 mdspan<3> [26, 4, 1]
// CHECK: Future:    ::bounded_decls{{(::paraby_[0-9]+)*}}::within_0::foreach_0::(anon), Type: sync=>local s32 mdspan<3> [6, 27, 1]
// CHECK: Function:  ::bounded_decls, Type: void (*)(s32 mdspan<3> [160, 27, 9])
