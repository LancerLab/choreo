// RUN: choreo -i %s | FileCheck --check-prefix=INFER --match-full-lines %s

__co__ void foo() {
  f32 [1024, 1024] g;
  parallel p by 1 {
    shared f32 [64, 128] a, b;
    with {m, n, k} in [16, 8, 4] {
      foreach k {
        c = select(k % 2, a, b);
// INFER: Symbol:    ::foo{{(::paraby_[0-9]+)*}}::within_0::foreach_0::c, Type: shared f32 mdspan<2> [64, 128]
      }
      foreach m, n, k {
        d0 = dma.copy.async g.chunkat(m, n) => select(k % 2, a, b);
// INFER: Future:    ::foo{{(::paraby_[0-9]+)*}}::within_0::foreach_1::d0, Type: async=>shared f32 mdspan<2> [64, 128]
      }
    }
    parallel q by 6 {
      local f32 [16, 32] x, y;
      with {m, n, k} in [4, 4, 4] {
        foreach k {
          z = select(k % 2, x, y);
// INFER: Symbol:    ::foo{{(::paraby_[0-9]+)*}}::within_1::foreach_2::z, Type: local f32 mdspan<2> [16, 32]
        }
        foreach m, n, k {
          d1 = dma.copy.async a.chunkat(m, n) => select(k % 2, x, y);
// INFER: Future:    ::foo{{(::paraby_[0-9]+)*}}::within_1::foreach_3::d1, Type: async=>local f32 mdspan<2> [16, 32]
          d2 = dma.copy.async a.chunkat(m, n) => local;
          f = select(1, d1, d2);
// INFER: Future:    ::foo{{(::paraby_[0-9]+)*}}::within_1::foreach_3::f, Type: async=>local f32 mdspan<2> [16, 32]
        }
      }
    }
  }
}
