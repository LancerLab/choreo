// RUN: choreo %s --debug-visit=latenorm -sa=latenorm 2>&1 | FileCheck %s

__co__ s32 [6, 17, 128] ele_add(s32 [6, 17, 128] lhs, s32 [6, 17, 128] rhs) {
  s32[lhs.span] output;

  parallel p by 6 {
    with index = {x, y} in [17, 4] {
      foreach x {
        // first bunch
        lfA = dma.copy.async lhs.chunkat(p, x, y) => local;
        rfA = dma.copy.async rhs.chunkat(p, x, y) => local;

        // dummy DMA used for A-B buffering
        lfB = dma.any;
        rfB = dma.any;
        of = dma.any;
        foreach y(1:) {
          lfB = dma.copy.async lhs.chunkat(p, x, y) => local;
          rfB = dma.copy.async rhs.chunkat(p, x, y) => local;
          wait lfA, rfA, of;

          l_out = select(y % 2, lfB.data, lfA.data);
          call kernel(lfA.data, rfA.data, l_out, |l_out|);

          of = dma.copy.async l_out => output.chunkat(p, x, y - 1);

          swap(lfA, lfB);
          swap(rfA, rfB);
        }
        lf = select(#y % 2, lfB, lfA);
        rf = select(#y % 2, rfB, rfA);
        wait lf, rf, of;
        call kernel(lf.data, rf.data, of.data, |of.span|);
        dma.copy of.data => output.chunkat(p, x, y(-1));
      }
    }
  }

  return output;
}

// CHECK: Hoisted:
// CHECK: `- Var Decl (): lfB__buf__, type: local s32 mdspan<3> [1, 1, 32]
// CHECK: Hoisted:
// CHECK: `- Var Decl (): rfB__buf__, type: local s32 mdspan<3> [1, 1, 32]
// CHECK: Hoisted:
// CHECK: `- Var Decl (): lfA__buf__, type: local s32 mdspan<3> [1, 1, 32]
// CHECK: Hoisted:
// CHECK: `- Var Decl (): rfA__buf__, type: local s32 mdspan<3> [1, 1, 32]
