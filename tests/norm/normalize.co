// RUN: choreo -dv=norm -sa=norm %s | FileCheck --match-full-lines %s

__co__ void foo(f32 [2, 3, 4] d, int e, bool, f32 mdspan<2> a) {
  c : a [(0), (1)];
  b : d [1, (0), (2)];
}

// CHECK: Name dims of `a': f32 <2> ---> f32 [ $0 $1 ]
// CHECK: Desugar ref: (0) ---> a(0)
// CHECK: Desugar ref: (1) ---> a(1)
// CHECK: Desugar ref: (0) ---> d(0)
// CHECK: Desugar ref: (2) ---> d(2)

__co__ auto foobar(f32 [?, 2, ?, 4] a) { return a; }

// CHECK: Name dims of `a': f32 [ ? 2 ? 4 ] ---> f32 [ $0 2 $1 4 ]

__co__ void bar() {
  f32 [1, 2, 3, 4] aa;
}

// CHECK: Place storage of 'aa': DEFAULT ---> GLOBAL

__co__ void fillup(f32 [3, 4, 5] b) {
  with abc in [b.span + 1] {}
}

// CHECK: Generate with-matchers for 'abc': abc__elem__0,abc__elem__1,abc__elem__2

__co__ void hoist_spanas(f32 [3, 4, 5] b) {
  with abc in [b.span + 1] {
    dma.copy b.span_as([4, 5, 6]).chunkat(abc) => global;
  }
}
// CHECK-NOT: AST::ChunkAt: replace abc with abc(unknown).

__co__ void hoist_bounded(f32 [3, 4, 5] b) {
  with index = {x, y, z} in [b.span + 1] {
    dma.copy b.chunkat(x, y + 1, z(0)) => global;
  }
}

// CHECK-NOT: AST::ChunkAt: replace x with x(unknown).
// CHECK: AST::ChunkAt: replace  (y + 1)  with anon_1(unknown).
// CHECK: Hoisted:
// CHECK: `- Assign: anon_1 =  (y + 1)
