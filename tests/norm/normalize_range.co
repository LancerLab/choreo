// RUN: choreo -dv=norm -sa=norm %s | FileCheck --match-full-lines %s

__co__ void foo(f32 [128, 256, 512] i, u8[16] ii) {
  t : [1, 2, 3];
  parallel p by 1 {
    with idx={a,b,c} in [4, 8, 16] {
      foreach a(1:#p-1) {
        foreach b(ii.span(0)*2:|ii|), c(|t|%3:cdiv(|ii|, 3)) {}
      }
    }
  }
}

// CHECK: AST::ForeachBlock: replace 
// CHECK: `- Iteration variables: a
// CHECK: `- Loop Control: (1: ( (ubound p)  - 1) :1) with 
// CHECK: `- Iteration variables: a
// CHECK: `- Loop Control: (anon_0: ( (ubound p)  - 1) :1).
// CHECK: AST::ForeachBlock: replace 
// CHECK: `- Iteration variables: a
// CHECK: `- Loop Control: (anon_0: ( (ubound p)  - 1) :1) with 
// CHECK: `- Iteration variables: a
// CHECK: `- Loop Control: (anon_0:anon_1:1).
// CHECK: AST::ForeachBlock: replace 
// CHECK: `- Iteration variables: b
// CHECK: `- Loop Control: ( (ii.span(0) * 2) : (sizeof ii) :1) with 
// CHECK: `- Iteration variables: b
// CHECK: `- Loop Control: (anon_2: (sizeof ii) :1).
// CHECK: AST::ForeachBlock: replace 
// CHECK: `- Iteration variables: c
// CHECK: `- Loop Control: ( ( (sizeof t)  % 3) : ( (sizeof ii)  cdiv 3) :1) with 
// CHECK: `- Iteration variables: c
// CHECK: `- Loop Control: (anon_3: ( (sizeof ii)  cdiv 3) :1).
// CHECK: AST::ForeachBlock: replace 
// CHECK: `- Iteration variables: b
// CHECK: `- Loop Control: (anon_2: (sizeof ii) :1) with 
// CHECK: `- Iteration variables: b
// CHECK: `- Loop Control: (anon_2:anon_4:1).
// CHECK: AST::ForeachBlock: replace 
// CHECK: `- Iteration variables: c
// CHECK: `- Loop Control: (anon_3: ( (sizeof ii)  cdiv 3) :1) with 
// CHECK: `- Iteration variables: c
// CHECK: `- Loop Control: (anon_3:anon_5:1).
// CHECK: Hoisted: 
// CHECK: `- Assign: anon_2 =  (ii.span(0) * 2) 
// CHECK: Hoisted: 
// CHECK: `- Assign: anon_3 =  ( (sizeof t)  % 3) 
// CHECK: Hoisted: 
// CHECK: `- Assign: anon_4 =  (sizeof ii) 
// CHECK: Hoisted: 
// CHECK: `- Assign: anon_5 =  ( (sizeof ii)  cdiv 3) 
// CHECK: Hoisted: 
// CHECK: `- Assign: anon_0 = 1
// CHECK: Hoisted: 
// CHECK: `- Assign: anon_1 =  ( (ubound p)  - 1)
