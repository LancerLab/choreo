add_all_gpu_archs() {
  set_add REQ_TARGETS "sm_86" "sm_90a"
}

add_gpu_arch() {
  local tgts="$@"
  for tgt in ${tgts}; do
    if [[ "${tgt}" == "SM_90" ]]; then set_add REQ_TARGETS "sm_90" "sm_90a";
    elif [[ "${tgt}" == "SM_90A" ]]; then set_add REQ_TARGETS "sm_90a";
    elif [[ "${tgt}" == "SM_"* ]]; then set_add REQ_TARGETS "$(tolower ${tgt})";
    elif [[ "${tgt}" == "GPU" ]]; then
      set_add REQ_TARGETS "sm_86" "sm_90a"
    fi
  done
}

gpu_detect() {
  if ! command -v nvidia-smi >/dev/null 2>&1; then
    return  # early exit if not installed
  fi

  # Run nvidia-smi and capture both output and exit code
  local smi_output
  if ! smi_output=$(nvidia-smi --query-gpu=name,compute_cap --format=csv,noheader 2>/dev/null); then
    # nvidia-smi failed (e.g., driver issue, no devices, etc.)
    cuda_arch="none"
    return
  fi

  # If output is empty, treat as no valid GPU
  if [ -z "$smi_output" ]; then
    cuda_arch="none"
    return
  fi

  # GPU device is available
  while IFS=',' read -r name cap; do
    name=$(echo "$name" | xargs)
    cap=$(echo "$cap" | xargs)

    # Defensive parsing
    if [ -z "$cap" ]; then
      cuda_arch="none"
      continue;
    fi

    major=${cap%%.*}
    minor=${cap##*.}

    # Ignore pre-sm_70
    if [ "$major" -lt 7 ]; then
      cuda_arch="none"
      continue;
    fi

    # Hopper special case
    if [ "$major" -eq 9 ] && [ "$minor" -eq 0 ]; then
      if echo "$name" | grep -qi "\(GH200\|H800\|H20\)"; then
        cuda_arch="sm_90a" # enforce sm_90a now
      else
        cuda_arch="sm_90"
      fi
    else
      cuda_arch="sm_${major}${minor}"
    fi
    break;
  done  <<< "$smi_output"

  # or else does not find a valid gpu device
  if [ "$cuda_arch" != "none" ]; then
    device_type="gpu"
    mach=${cuda_arch}
  fi
}

register_hook "all_archs" "add_all_gpu_archs"
register_hook "set_archs" "add_gpu_arch"
register_hook "hw_detect" "gpu_detect"
