// REQUIRES: TARGET-SM_90A
// RUN: choreo -gs -t cute -arch=sm_90a -sim %s -o %s.cute.result && bash %s.cute.result --execute | FileCheck --match-full-lines %s && rm -f %s.cute.result

__co__ auto dma_copy_sparse(s32 [6, 17, 64] input) {
  s32 [input.span] output;

  parallel by 1, by 1 {
    f = dma.copy.sp(2:4) input => shared;
    dma.copy.sp(2:4) f.data => output;
  }

  return output;
}

int main() { /// host program
  auto a = choreo::make_spandata<choreo::s32>(6, 17, 64);
  a.fill_random(-10, 10);
  // enforce 2:4 sparsity on K dimension
  for (size_t i = 0; i < a.shape()[0]; ++i)
    for (size_t j = 0; j < a.shape()[1]; ++j)
      for (size_t k4 = 0; k4 < a.shape()[2] / 4; ++k4) {
        size_t base = k4 * 4;
        // keep first two elements, zero the rest
        a[i][j][base + 2] = 0;
        a[i][j][base + 3] = 0;
      }

  auto res0 = dma_copy_sparse(a.view());

  // verification
  for (size_t i = 0; i < res0.shape()[0]; ++i)
    for (size_t j = 0; j < res0.shape()[1]; ++j)
      for (size_t k = 0; k < res0.shape()[2]; ++k)
        choreo::choreo_assert(a[i][j][k] == res0[i][j][k], "values are not equal.");

  std::cout << "Test Passed\n" << std::endl;
}

// CHECK: Test Passed
