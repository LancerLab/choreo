// REQUIRES: TARGET-SM_90A
// RUN: choreo -gs -t cute -arch=sm_90a %s -o %s.cute.result && CHOREO_DISABLE_TIMING=1 bash %s.cute.result --execute | FileCheck --match-full-lines %s && rm -f %s.cute.result

#define M 64
#define N 128
#define K 32

__co__ auto matmul(f8_e4m3 [M, K] lhs, f8_e4m3 [N, K] rhs) {
  f32 [M, N] output{0.0f};

  int WARP_M = 64, WARP_N = 64, TILE_K = 32, WARP_K = 32;

  // each block handles 64x64 block with WGMMA
  // WGMMA requires 128 threads (4 warps x 32 threads/warp)
  parallel {block_m, block_n} by [cdiv(M, WARP_M), cdiv(N, WARP_N)] : block {
    mc = mma.fill.f32 0.0f;
    foreach {iv_k} in [cdiv(K, TILE_K)] {
      lhs_load_s = tma.copy.swiz<32> lhs.chunkat(block_m, iv_k) => shared;
      rhs_load_s = tma.copy.swiz<32> rhs.chunkat(block_n, iv_k) => shared;
      foreach {iv_warp} in [cdiv(TILE_K, WARP_K)] {
        parallel p by 1 : group-4 {
          ma = mma.load.swiz<32> lhs_load_s.chunkat(_, iv_warp);
          mb = mma.load.swiz<32> rhs_load_s.chunkat(_, iv_warp);
          mma.row.row mc, ma, mb;   // row * row : c += a * b;
        }
      }
    }
    mma.store mc, output.chunkat(block_m, block_n);
  }

  return output;
}

int main(int argc, char** argv) {
  bool enable_timing = true;
  auto is_disable_timing_arg = [](const char* s) {
    const char* t = "--disable-timing";
    int i = 0;
    while (t[i] != '\0' && s[i] == t[i]) ++i;
    return t[i] == '\0' && s[i] == '\0';
  };
  for (int i = 1; i < argc; ++i) {
    if (is_disable_timing_arg(argv[i])) {
      enable_timing = false;
      break;
    }
  }

  const char* timing_env = std::getenv("CHOREO_DISABLE_TIMING");
  if (timing_env && timing_env[0] == '1' && timing_env[1] == '\0') {
    enable_timing = false;
  }

  auto lhs = choreo::make_spandata<choreo::f8_e4m3>(M, K);
  auto rhs = choreo::make_spandata<choreo::f8_e4m3>(N, K);
  lhs.fill_random(-2.0f, 2.0f);
  rhs.fill_random(-2.0f, 2.0f);

  if (enable_timing) {
    choreo::TimerOption topt;
    topt.warmup = 10;
    topt.repeat = 50;
    auto avg_ms = choreo::timing(
        [&]() { matmul(lhs.view(), rhs.view()); },
        topt);
    std::cout << "Timing avg ms: " << avg_ms << "\n";
  }

  auto res = matmul(lhs.view(), rhs.view());

  float base_tol = 0.3f;
  float rel_tol = 0.05f;
  choreo::verify_matmul_row_row_subset(lhs, rhs, res, base_tol, rel_tol, 8, 8);

  std::cout << "Test Passed\n" << std::endl;
}

// CHECK: Test Passed
