// REQUIRES: TARGET-SM_90
// RUN: choreo -gs -t cute -arch=sm_90 %s -o %s.cute.result && bash %s.cute.result --execute | FileCheck --match-full-lines %s && rm -f %s.cute.result

__co__ auto tma_copy_tiled(f32 [6, 16, 128] input) {
  f32 [input.span] output;

  parallel p by 32 : block {
    f = tma.copy.async input.chunkat(_,_,p) => shared;
    wait f;
    tma.copy f.data => output.chunkat(_,_,p);
  }

  return output;
}

int main() { /// host program
  auto a = choreo::make_spandata<choreo::f32>(6, 16, 128);
  a.fill_random(-10.0f, 10.0f);

  auto res1 = tma_copy_tiled(a.view());

  // verfication
  for (size_t i = 0; i < res1.shape()[0]; ++i)
    for (size_t j = 0; j < res1.shape()[1]; ++j)
      for (size_t k = 0; k < res1.shape()[2]; ++k) {
        choreo::choreo_assert(a[i][j][k] == res1[i][j][k], "values are not equal.");
      }

  std::cout << "Test Passed\n" << std::endl;
}

// CHECK: Test Passed
