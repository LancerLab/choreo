// REQUIRES: TARGET-SM_90
// RUN: choreo -gs -t cute -arch=sm_90a -use-cuda-type=false %s -o %s.cute.result && bash %s.cute.result --execute | FileCheck --match-full-lines %s && rm -f %s.cute.result

__co__ auto dma_copy_sync_f6_e3m2(f6_e3m2 [6, 17, 64] input) {
  f6_e3m2 [input.span] output;

  parallel by 1, by 1 {
    f = dma.copy input => shared;
    dma.copy f.data => output;
  }

  return output;
}

__co__ auto dma_copy_sync_f6_e2m3(f6_e2m3 [6, 17, 64] input) {
  f6_e2m3 [input.span] output;

  parallel by 1, by 1 {
    f = dma.copy input => shared;
    dma.copy f.data => output;
  }

  return output;
}

__co__ auto dma_copy_sync_f4_e2m1(f4_e2m1 [6, 17, 64] input) {
  f4_e2m1 [input.span] output;

  parallel by 1, by 1 {
    f = dma.copy input => shared;
    dma.copy f.data => output;
  }

  return output;
}

int main() {
  {
    auto a = choreo::make_spandata<choreo::f6_e3m2>(6, 17, 64);
    a.fill_random(-2.0f, 2.0f);

    auto res0 = dma_copy_sync_f6_e3m2(a.view());

    for (size_t i = 0; i < res0.shape()[0]; ++i)
      for (size_t j = 0; j < res0.shape()[1]; ++j)
        for (size_t k = 0; k < res0.shape()[2]; ++k)
          choreo::choreo_assert(float(a[i][j][k]) == float(res0[i][j][k]),
                                "values are not equal.");

    std::cout << "Test 0 Passed\n" << std::endl;
  }

  {
    auto a = choreo::make_spandata<choreo::f6_e2m3>(6, 17, 64);
    a.fill_random(-2.0f, 2.0f);

    auto res1 = dma_copy_sync_f6_e2m3(a.view());

    for (size_t i = 0; i < res1.shape()[0]; ++i)
      for (size_t j = 0; j < res1.shape()[1]; ++j)
        for (size_t k = 0; k < res1.shape()[2]; ++k)
          choreo::choreo_assert(float(a[i][j][k]) == float(res1[i][j][k]),
                                "values are not equal.");

    std::cout << "Test 1 Passed\n" << std::endl;
  }

  {
    auto a = choreo::make_spandata<choreo::f4_e2m1>(6, 17, 64);
    a.fill_random(-2.0f, 2.0f);

    auto res2 = dma_copy_sync_f4_e2m1(a.view());

    for (size_t i = 0; i < res2.shape()[0]; ++i)
      for (size_t j = 0; j < res2.shape()[1]; ++j)
        for (size_t k = 0; k < res2.shape()[2]; ++k)
          choreo::choreo_assert(float(a[i][j][k]) == float(res2[i][j][k]),
                                "values are not equal.");

    std::cout << "Test 2 Passed\n" << std::endl;
  }
}

// CHECK: Test 0 Passed
// CHECK: Test 1 Passed
// CHECK: Test 2 Passed
