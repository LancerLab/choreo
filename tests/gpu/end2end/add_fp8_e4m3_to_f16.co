// REQUIRES: TARGET-SM_90
// RUN: choreo -gs -t cute -arch=sm_90a %s -o %s.cute.result && bash %s.cute.result --execute | FileCheck --match-full-lines %s && rm -f %s.cute.result

__co__ auto ele_add_fp8(f8_e4m3 [6, 64] lhs, f8_e4m3 [6, 64] rhs) {
  f16[lhs.span] output;

  parallel p by 6, q by 64
    output.at(p, q) = lhs.at(p, q) + rhs.at(p, q);

  return output;
}

int main() {
  using t = choreo::f8_e4m3;
  auto a = choreo::make_spandata<t>(6, 64);
  auto b = choreo::make_spandata<t>(6, 64);
  a.fill_random(-2.0f, 2.0f);
  b.fill_random(-2.0f, 2.0f);

  auto res = ele_add_fp8(a.view(), b.view());

  // verification (FP8 inputs, FP16 output)
  float tolerance = 0.35f;
  for (size_t i = 0; i < res.shape()[0]; ++i)
    for (size_t j = 0; j < res.shape()[1]; ++j) {
      float ref = float(a[i][j]) + float(b[i][j]);
      float got = float(res[i][j]);
      float diff = std::abs(got - ref);
      if (diff > tolerance) {
        std::cout << "[" << i << ", " << j << "] ref=" << ref << " got=" << got << " diff=" << diff << "\n";
      }
      choreo::choreo_assert(diff <= tolerance, "values are not equal.");
    }

  std::cout << "Test Passed\n" << std::endl;
}

// CHECK: Test Passed
