// RUN:choreo -E %s | FileCheck --match-full-lines %s
#define ADD(a , b) (a + b)
#define SUB(a, b) (a - b)
#define min_(a, b) (((a) < (b)) ? (a) : (b))

SUB(ADD(a, b), 1)

__co__ void foo(f32 [128] a) {
  #define MUL(a, b) (a * b)
  #define DIV(a, b) (a / b)
  #define NESTED_ADD(a, b) ADD(ADD(a, b), b)
  foreach {i} in [a.span(0)] {
    a.at(i) = ADD(a.at(i), 1.0f);
    a.at(i) = NESTED_ADD(a.at(i), 1.0f);
    a.at(i) = ADD(SUB(a.at(i), 1.0f), SUB(a.at(i), 1.0f));
    a.at(i) = ADD(SUB(MUL(DIV(a.at(i), 3.0f), 2.0f), 1.0f), 1.0f);
    a.at(i) = min_(a.at(i), 1.0f);
  }
}


// CHECK: #define ADD(a , b) (a + b)
// CHECK: #define SUB(a, b) (a - b)
// CHECK: SUB(ADD(a, b), 1)
// CHECK: a.at(i) = (a.at(i) + 1.0f);
// CHECK: a.at(i) = ((a.at(i) + 1.0f) + 1.0f);
// CHECK: a.at(i) = ((a.at(i) - 1.0f) + (a.at(i) - 1.0f));
// CHECK: a.at(i) = ((((a.at(i) / 3.0f) * 2.0f) - 1.0f) + 1.0f);
// CHECK: a.at(i) = (((a.at(i)) < (1.0f)) ? (a.at(i)) : (1.0f));